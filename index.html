<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrôle LED ESP32 Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #00ff88;
            --dark-bg: #1a1a2e;
            --light-bg: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --text-dark: #111111;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Titre principal */
        .main-title {
            text-align: center;
            color: var(--primary);
            margin: 0 0 30px 0;
            padding: 10px;
            position: relative;
        }

        .rainbow-text {
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, 
                #00ff00, #00ffff, #0000ff, 
                #8000ff, #ff0080);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: rainbow-slide 8s linear infinite;
            background-size: 400% auto;
        }

        @keyframes rainbow-slide {
            0% { background-position: 0% 50%; }
            100% { background-position: 400% 50%; }
        }

        /* Panneau de contrôle */
        .control-panel {
            background: var(--light-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Sélection de couleur */
        .color-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
        }

        .color-preview {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .color-preview:hover {
            transform: scale(1.1);
        }

        /* Boutons d'effets */
        .effects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
            margin: 25px 0;
        }

        .effect-btn {
            padding: 15px 10px;
            border: none;
            border-radius: 8px;
            background: var(--light-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .effect-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .effect-btn.active {
            background: var(--primary);
            color: var(--text-dark);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }

        /* Contrôles */
        .controls-row {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .control-section {
            flex: 1;
            min-width: 200px;
        }

        .slider-control {
            width: 100%;
            margin-top: 8px;
        }

        /* Contrôle BPM */
        .bpm-control {
            background: var(--light-bg);
            padding: 15px;
            border-radius: 8px;
        }

        .bpm-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 6px;
            border: 1px solid var(--primary);
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
        }

        .multipliers {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .multiplier {
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .multiplier.active {
            background: var(--primary);
            color: var(--text-dark);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">
            <span class="rainbow-text">Contrôle LED Pro</span>
        </h1>

        <div class="control-panel">
            <!-- Sélecteur de couleur -->
            <div class="color-selector">
                <input type="color" id="colorPicker" value="#00ff88" class="color-preview">
                <button class="effect-btn" onclick="setSolidColor()">
                    <i class="fas fa-fill-drip"></i> Couleur Unie
                </button>
            </div>

            <!-- Effets -->
            <div class="effects-grid">
                <button class="effect-btn" data-effect="rainbow" onclick="toggleEffect(this)">
                    <i class="fas fa-rainbow"></i>
                    <span>Arc-en-Ciel</span>
                </button>
                <button class="effect-btn" data-effect="strobe" onclick="toggleEffect(this)">
                    <i class="fas fa-stroopwafel"></i>
                    <span>Stroboscope</span>
                </button>
                <button class="effect-btn" data-effect="pulse" onclick="toggleEffect(this)">
                    <i class="fas fa-heartbeat"></i>
                    <span>Pulsation</span>
                </button>
                <button class="effect-btn" data-effect="nebula" onclick="toggleEffect(this)">
                    <i class="fas fa-galaxy"></i>
                    <span>Nébuleuse</span>
                </button>
                <button class="effect-btn" data-effect="lava" onclick="toggleEffect(this)">
                    <i class="fas fa-fire"></i>
                    <span>Lave</span>
                </button>
            </div>

            <!-- Contrôles -->
            <div class="controls-row">
                <!-- Luminosité -->
                <div class="control-section">
                    <label><i class="fas fa-sun"></i> Luminosité</label>
                    <input type="range" min="0" max="255" value="255" class="slider-control" oninput="updateBrightness(this.value)">
                </div>

                <!-- BPM -->
                <div class="bpm-control">
                    <label><i class="fas fa-heartbeat"></i> BPM (30-300)</label>
                    <input type="number" id="bpmInput" value="120" min="30" max="300" class="bpm-input">
                    
                    <div class="multipliers">
                        <div class="multiplier" data-mult="0.25" onclick="setMultiplier(0.25)">1/4x</div>
                        <div class="multiplier" data-mult="0.5" onclick="setMultiplier(0.5)">1/2x</div>
                        <div class="multiplier active" data-mult="1" onclick="setMultiplier(1)">1x</div>
                        <div class="multiplier" data-mult="2" onclick="setMultiplier(2)">2x</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
 <script>
    // État global de l'application
    const appState = {
        currentEffect: null,
        currentBPM: 120,
        currentMultiplier: 1,
        brightness: 255,
        currentColor: '#00ff88'
    };

    // Calcul de la vitesse basée sur le BPM
    function calculateSpeed() {
        const bps = appState.currentBPM / 60; // Battements par seconde
        const interval = 1 / (bps * appState.currentMultiplier);
        return Math.round(interval * 1000); // Conversion en ms
    }

    // Gestion des effets
    async function toggleEffect(button) {
        try {
            // Désactivation si c'est le même effet
            if (appState.currentEffect === button) {
                button.classList.remove('active');
                appState.currentEffect = null;
                await sendCommand('/effect?name=off');
                updateTitle();
                return;
            }

            // Désactiver l'effet précédent
            if (appState.currentEffect) {
                appState.currentEffect.classList.remove('active');
            }

            // Activer le nouvel effet
            button.classList.add('active');
            appState.currentEffect = button;
            
            const effectName = button.dataset.effect;
            const speed = calculateSpeed();
            
            await sendCommand(`/effect?name=${effectName}&speed=${speed}`);
            updateTitle();
            updateVisualFeedback(effectName);
            
        } catch (error) {
            console.error("Erreur lors du changement d'effet:", error);
            showStatus("Erreur de communication", 'error');
        }
    }

    // Définir une couleur unie
    async function setSolidColor() {
        try {
            appState.currentColor = document.getElementById('colorPicker').value;
            const rgb = hexToRGB(appState.currentColor);
            
            // Désactiver tout effet en cours
            if (appState.currentEffect) {
                appState.currentEffect.classList.remove('active');
                appState.currentEffect = null;
            }
            
            await sendCommand(`/color?r=${rgb.r}&g=${rgb.g}&b=${rgb.b}`);
            updateTitle();
            updateVisualFeedback('solid');
            
        } catch (error) {
            console.error("Erreur lors du changement de couleur:", error);
            showStatus("Erreur de communication", 'error');
        }
    }

    // Conversion HEX vers RGB
    function hexToRGB(hex) {
        return {
            r: parseInt(hex.substring(1, 3), 16),
            g: parseInt(hex.substring(3, 5), 16),
            b: parseInt(hex.substring(5, 7), 16)
        };
    }

    // Changer le multiplicateur BPM
    function setMultiplier(multiplier) {
        appState.currentMultiplier = multiplier;
        
        // Mettre à jour l'interface
        document.querySelectorAll('.multiplier').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mult == multiplier);
        });
        
        // Mettre à jour l'effet en cours
        if (appState.currentEffect) {
            toggleEffect(appState.currentEffect);
        }
    }

    // Mettre à jour la luminosité
    function updateBrightness(value) {
        appState.brightness = value;
        if (!appState.currentEffect) {
            setSolidColor(); // Mettre à jour la couleur avec la nouvelle luminosité
        }
        updateTitle();
    }

    // Feedback visuel
    function updateVisualFeedback(effect) {
        const title = document.getElementById('title');
        
        // Reset des classes
        title.className = 'main-title';
        title.style.color = '';
        
        if (effect === 'rainbow') {
            title.classList.add('rainbow-text');
        } else if (effect === 'solid') {
            title.style.color = appState.currentColor;
        }
    }

    // Envoyer une commande au serveur
    async function sendCommand(url) {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response;
    }

    // Mettre à jour le titre
    function updateTitle() {
        const title = document.getElementById('title');
        const modeText = document.getElementById('modeText');
        const paramsText = document.getElementById('paramsText');
        
        if (appState.currentEffect) {
            const effectName = appState.currentEffect.dataset.effect;
            const effectNames = {
                'rainbow': '🌈 Mode Arc-en-Ciel',
                'strobe': '✨ Mode Stroboscope',
                'pulse': '💓 Mode Pulsation',
                'nebula': '🌌 Mode Nébuleuse',
                'lava': '🌋 Mode Lave'
            };
            
            modeText.textContent = effectNames[effectName] || 'Mode Actif';
            paramsText.textContent = `BPM: ${appState.currentBPM} ×${appState.currentMultiplier} | Lum: ${appState.brightness}`;
        } else {
            modeText.textContent = '🎨 Couleur Unie';
            paramsText.textContent = `${appState.currentColor} | Lum: ${appState.brightness}`;
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', () => {
        // Écouteurs d'événements
        document.getElementById('bpmInput').addEventListener('input', (e) => {
            appState.currentBPM = Math.min(300, Math.max(30, e.target.value || 120));
            if (appState.currentEffect) {
                toggleEffect(appState.currentEffect);
            }
        });
        
        // Initialiser l'interface
        updateTitle();
        updateVisualFeedback('solid');
    });
</script>
</body>
</html>
